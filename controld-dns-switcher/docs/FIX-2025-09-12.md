# DNS Switcher Fix - September 12, 2025

## Problem Summary

The original `quick-dns-switch` v3.0.0 script was failing with exit code 1 during profile switching operations. The script would start but hang during network state detection, preventing successful DNS profile changes between `gaming` and `privacy` modes.

## Issues Identified

1. **Network Detection Hanging**: The complex VPN detection and network intelligence features were causing the script to hang during execution
2. **Missing Configuration**: The required `/opt/controld-switcher/etc/config.json` file was missing
3. **Overly Complex Script**: The v3.0.0 script had excessive features that were causing reliability issues
4. **Multiple Conflicting Processes**: Multiple ctrld processes were running simultaneously

## Solution Implemented

### 1. Created Simplified Working Script
- **File**: `quick-dns-switch-simple` (backed up as `bin/quick-dns-switch-working`)
- **Features**: 
  - Direct DNS profile switching without complex network detection
  - Proper LaunchDaemon management
  - Status tracking with JSON output
  - Desktop notifications
  - Logging to `/var/log/ctrld-switcher/switcher.log`

### 2. Fixed Configuration
- Created missing `/opt/controld-switcher/etc/config.json`
- Ensured proper directory permissions
- Cleared stale lock files

### 3. Service Management
- Properly stops and starts Control D services
- Eliminates process conflicts
- Validates service startup

## Installation/Restoration Steps

If the fix needs to be restored on this or another system:

### 1. Install the working script:
```bash
sudo cp controld-dns-switcher/bin/quick-dns-switch-working /usr/local/bin/quick-dns-switch-simple
sudo chmod +x /usr/local/bin/quick-dns-switch-simple
```

### 2. Replace the broken original:
```bash
sudo mv /usr/local/bin/quick-dns-switch /usr/local/bin/quick-dns-switch-original
sudo ln -s /usr/local/bin/quick-dns-switch-simple /usr/local/bin/quick-dns-switch
```

### 3. Create required directories and config:
```bash
sudo mkdir -p /opt/controld-switcher/etc
sudo mkdir -p /var/run/ctrld-switcher
sudo mkdir -p /var/log/ctrld-switcher

# Create config file:
sudo tee /opt/controld-switcher/etc/config.json > /dev/null << 'EOF'
{
  "version": "3.0.0",
  "profiles": {
    "privacy": {
      "id": "2eoeqoo9ib9",
      "endpoint": "https://dns.controld.com/2eoeqoo9ib9",
      "description": "Enhanced security and privacy filtering"
    },
    "gaming": {
      "id": "1igcvpwtsfg", 
      "endpoint": "https://dns.controld.com/1igcvpwtsfg",
      "description": "Low latency gaming optimization"
    }
  },
  "network": {
    "timeout": 5000,
    "retries": 3
  }
}
EOF
```

## Usage

```bash
# Switch to gaming profile (for Nvidia GeForce NOW, etc.)
sudo quick-dns-switch gaming

# Switch to privacy profile  
sudo quick-dns-switch privacy

# Check current status
quick-dns-switch status
```

## Verification

The fix can be verified by:

1. **Profile switching works**: Commands complete with exit code 0
2. **Status updates**: JSON status shows correct profile and timestamp
3. **Service validation**: `ps aux | grep ctrld` shows correct process running
4. **Desktop notifications**: macOS notifications appear on profile switch

## Files Modified/Created

### System Files:
- `/usr/local/bin/quick-dns-switch-simple` - Working script
- `/usr/local/bin/quick-dns-switch` - Symlink to working script  
- `/usr/local/bin/quick-dns-switch-original` - Original broken script (preserved)
- `/opt/controld-switcher/etc/config.json` - Configuration file

### Repository Backups:
- `bin/quick-dns-switch-working` - Working script backup
- `legacy/quick-dns-switch-v3.0.0-broken` - Original broken script backup
- `docs/FIX-2025-09-12.md` - This documentation

## Technical Details

### Profile Configurations:
- **Privacy Profile**: ID `2eoeqoo9ib9`, Endpoint `https://dns.controld.com/2eoeqoo9ib9`
- **Gaming Profile**: ID `1igcvpwtsfg`, Endpoint `https://dns.controld.com/1igcvpwtsfg`
- **Local Resolver**: Configured to listen on appropriate interface

### Key Improvements:
1. **Reliability**: Removed complex network detection that was causing hangs
2. **Speed**: Direct profile switching without unnecessary delays
3. **Compatibility**: Works with existing workflows and commands
4. **Monitoring**: Proper status tracking and logging
5. **User Experience**: Desktop notifications and clear feedback

## Final Fix Applied - 2025-09-12 11:40 AM

Additional issues were discovered and resolved:

### Issues Found:
1. **Read-only filesystem error**: The ctrld binary was failing because it couldn't write `ctrld.toml` to the current directory
2. **Hanging pkill command**: The regex pattern `[c]trld` was causing the pkill command to hang
3. **Bootstrap command hanging**: The `launchctl bootstrap` command was hanging on execution
4. **Port validation hanging**: The `lsof` port check was causing script hangs

### Final Solutions:
1. **Added WorkingDirectory**: Set `/var/run/ctrld-switcher` as working directory in LaunchDaemon plist
2. **Fixed pkill pattern**: Changed from `[c]trld` to `'ctrld run'` to avoid regex issues
3. **Replaced bootstrap**: Used `launchctl load/unload -w` instead of `bootstrap/bootout`
4. **Removed port validation**: Simplified service validation to avoid hanging

## Status: âœ… FULLY RESOLVED

The DNS profile switching functionality is now fully operational with all hanging issues resolved. Both gaming and privacy profiles switch successfully with proper status tracking and desktop notifications.
