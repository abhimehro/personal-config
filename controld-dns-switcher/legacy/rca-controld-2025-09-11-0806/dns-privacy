#!/usr/bin/env bash
set -Eeuo pipefail

source /usr/local/bin/dns-common.sh

PROFILE="privacy"

main() {
  run_preflight_checks "$PROFILE" || { emergency_rollback "Preflight checks failed"; exit 1; }

  # Switch to privacy profile
  if ! switch_ctrld_profile "$PROFILE"; then
    emergency_rollback "Failed to switch ctrld profile to $PROFILE"
    exit 1
  fi

  # Set system DNS to 127.0.0.1
  if ! set_system_dns "127.0.0.1"; then
    emergency_rollback "Failed to set system DNS to 127.0.0.1"
    exit 1
  fi

  flush_dns_cache

  # Verify setup
  if ! verify_dns_setup "$PROFILE"; then
    emergency_rollback "Verification failed for $PROFILE"
    exit 1
  fi

  log "Done."
}

main "$@"

