# ─ include the 1Password‑managed keys ───────────────
Include ~/.ssh/1Password/config

# ─ GitHub configuration ──────────────────────────────
# Uses 1Password SSH agent for key management
Host github.com
    HostName github.com
    User git
    IdentitiesOnly no
    # Keys provided by 1Password agent (overrides global IdentitiesOnly yes)

# ─ Dynamic configuration for MacBook Air M2 (Cursor IDE) ────────
# This configuration automatically adapts to VPN on/off scenarios

# VPN ON: Windscribe Static IP with Port Forwarding
# Port Forward: 36555 (external) → 22 (internal SSH)
Host cursor-vpn
    HostName 82.21.151.194         # Windscribe Atlanta static IP
    Port 36555                     # External port (Windscribe forwards to :22)
    User abhimehrotra
    IdentitiesOnly yes
    RequestTTY yes
    ServerAliveInterval 60
    Compression yes
    ControlMaster auto
    ControlPath ~/.ssh/control/%r@%h:%p
    ControlPersist 30m
    PubkeyAcceptedKeyTypes +ssh-ed25519
    StrictHostKeyChecking accept-new
    # VPN-specific optimizations
    TCPKeepAlive yes
    ServerAliveCountMax 5

# VPN OFF: Use local hostname (mDNS)
Host cursor-local
    HostName abhis-macbook-air.local
    User abhimehrotra
    IdentitiesOnly yes
    RequestTTY yes
    ServerAliveInterval 60
    Compression yes
    ControlMaster auto
    ControlPath ~/.ssh/control/%r@%h:%p
    ControlPersist 30m
    PubkeyAcceptedKeyTypes +ssh-ed25519
    StrictHostKeyChecking accept-new
    # Local network optimizations
    Compression no

# FALLBACK: Use .local domain (mDNS/Bonjour)
Host cursor-mdns
    HostName abhis-macbook-air.local
    User abhimehrotra
    IdentitiesOnly yes
    RequestTTY yes
    ServerAliveInterval 60
    Compression yes
    ControlMaster auto
    ControlPath ~/.ssh/control/%r@%h:%p
    ControlPersist 30m
    PubkeyAcceptedKeyTypes +ssh-ed25519
    StrictHostKeyChecking accept-new

# SMART ALIAS: Auto-detect which connection to use
Host cursor-auto
    HostName abhis-macbook-air.local
    User abhimehrotra
    IdentitiesOnly yes
    RequestTTY yes
    ServerAliveInterval 30
    ConnectTimeout 5
    ConnectionAttempts 1
    ControlMaster auto
    ControlPath ~/.ssh/control/%r@%h:%p
    ControlPersist 30m
    PubkeyAcceptedKeyTypes +ssh-ed25519
    StrictHostKeyChecking accept-new

# ─ global defaults for all hosts ─────────────────────
Host *
  IdentityAgent "~/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"

    # Ensure compatibility with non-macOS OpenSSH
    IgnoreUnknown UseKeychain

    # Key management
    AddKeysToAgent yes
    UseKeychain yes
    IdentitiesOnly yes

    # Connection persistence and reliability
    ServerAliveInterval 60
    ServerAliveCountMax 3
    TCPKeepAlive yes

    # Connection multiplexing (ensure control directory exists)
    ControlMaster auto
    ControlPath ~/.ssh/control/%r@%h:%p
    ControlPersist 10m

    # Security settings
    HashKnownHosts yes
    StrictHostKeyChecking accept-new
    
    # Performance optimizations
    Compression yes
