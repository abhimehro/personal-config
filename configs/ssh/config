# ─ include the 1Password‑managed keys ───────────────
Include ~/.ssh/1Password/config

#  GitHub configuration 
# Uses 1Password SSH agent for key management
Host github.com
    HostName github.com
    User git
    IdentitiesOnly no
    # Keys provided by 1Password agent (overrides global IdentitiesOnly yes)

#  Proton Pass SSH agent: GitHub alias 
# Use Proton Pass SSH agent for GitHub under alias "github-proton".
# Requires Proton's ssh-agent running (see pp_ssh_agent_start) OR
# at least ~/.ssh/proton-pass-agent.sock pointing at a valid agent.
Host github-proton
    HostName github.com
    User git
    IdentitiesOnly yes
    IdentityAgent "~/.ssh/proton-pass-agent.sock"

#  Generic Proton-host pattern (optional) 
# Any host whose name matches "proton-*" will prefer Proton's agent.
# Example usage:
#   Host proton-example
#       HostName example.com
#       User myuser
Host proton-*
    IdentitiesOnly yes
    IdentityAgent "~/.ssh/proton-pass-agent.sock"

# ─ Dynamic configuration for primary development laptop ────────
# This configuration automatically adapts to VPN on/off scenarios.
# Hostnames and usernames are intentionally generic so this file can
# be reused across machines.

# VPN ON: static IP / VPN / remote port forward
Host dev-vpn
    HostName <vpn-ip-address>          # set locally, e.g. VPN static IP
    Port 22                            # set locally if needed (e.g. 13161 -> sshd :22)
    User <dev-username>                # set per-machine username
    IdentitiesOnly yes
    RequestTTY yes
    ServerAliveInterval 60
    Compression yes
    ControlMaster auto
    ControlPath ~/.ssh/control/%r@%h:%p
    ControlPersist 30m
    PubkeyAcceptedKeyTypes +ssh-ed25519
    StrictHostKeyChecking accept-new
    # VPN-specific optimizations
    TCPKeepAlive yes
    ServerAliveCountMax 5

# VPN OFF: Use local hostname (mDNS)
Host dev-local
    HostName <dev-hostname-local>      # e.g. my-laptop.local
    User <dev-username>
    IdentitiesOnly yes
    RequestTTY yes
    ServerAliveInterval 60
    Compression yes
    ControlMaster auto
    ControlPath ~/.ssh/control/%r@%h:%p
    ControlPersist 30m
    PubkeyAcceptedKeyTypes +ssh-ed25519
    StrictHostKeyChecking accept-new
    # Local network optimizations
    Compression no

# FALLBACK: Use .local domain (mDNS/Bonjour)
Host dev-mdns
    HostName <dev-hostname-local>
    User <dev-username>
    IdentitiesOnly yes
    RequestTTY yes
    ServerAliveInterval 60
    Compression yes
    ControlMaster auto
    ControlPath ~/.ssh/control/%r@%h:%p
    ControlPersist 30m
    PubkeyAcceptedKeyTypes +ssh-ed25519
    StrictHostKeyChecking accept-new

# SMART ALIAS: Auto-detect which connection to use
Host dev-auto
    HostName <dev-hostname-local>
    User <dev-username>
    IdentitiesOnly yes
    RequestTTY yes
    ServerAliveInterval 30
    ConnectTimeout 5
    ConnectionAttempts 1
    ControlMaster auto
    ControlPath ~/.ssh/control/%r@%h:%p
    ControlPersist 30m
    PubkeyAcceptedKeyTypes +ssh-ed25519
    StrictHostKeyChecking accept-new

# ─ global defaults for all hosts ─────────────────────
Host *
  IdentityAgent "~/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"

    # Ensure compatibility with non-macOS OpenSSH
    IgnoreUnknown UseKeychain

    # Key management
    AddKeysToAgent yes
    UseKeychain yes
    IdentitiesOnly yes

    # Connection persistence and reliability
    ServerAliveInterval 60
    ServerAliveCountMax 3
    TCPKeepAlive yes

    # Connection multiplexing (ensure control directory exists)
    ControlMaster auto
    ControlPath ~/.ssh/control/%r@%h:%p
    ControlPersist 10m

    # Security settings
    StrictHostKeyChecking ask
    HashKnownHosts yes
    UserKnownHostsFile ~/.ssh/known_hosts

    # Performance and features
    Compression yes
    # SECURITY: Disable forwarding by default to prevent agent hijacking and X11 attacks
    ForwardAgent no
    ForwardX11 no
    ForwardX11Trusted no

    # Environment
    SendEnv LANG LC_*

    # Timeout settings
    ConnectTimeout 30

    # Prevent hanging connections
    ExitOnForwardFailure yes

    # Preferred key types (modern, secure)
    PubkeyAcceptedKeyTypes ssh-ed25519,ecdsa-sha2-nistp256,ssh-rsa
    HostkeyAlgorithms +ssh-ed25519,ecdsa-sha2-nistp256,ssh-rsa
    # Note: Removed trailing comma from KexAlgorithms for valid syntax
    KexAlgorithms +diffie-hellman-group-exchange-sha256,diffie-hellman-group14-sha256,curve25519-sha256
