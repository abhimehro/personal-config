# ─ include the 1Password‑managed keys ───────────────
Include ~/.ssh/1Password/config

# ─ GitHub configuration ──────────────────────────────
Host github.com
    HostName github.com
    User git
    IdentityFile ~/.ssh/github_ed25519
    IdentitiesOnly yes

# ─ Dynamic configuration for MacBook Air M2 (Cursor IDE) ────────
# This configuration automatically adapts to VPN on/off scenarios

# VPN ON: Windscribe/Tailscale/static IP (set locally; keep placeholders in repo)
Host cursor-vpn
    HostName <vpn-ip-address>      # set locally, e.g. Windscribe static IP
    Port 22                        # set locally if needed (e.g. 13161 -> sshd :22)
    User abhimehrotra
    IdentitiesOnly yes
    RequestTTY yes
    ServerAliveInterval 60
    Compression yes
    ControlMaster auto
    ControlPath ~/.ssh/control/%r@%h:%p
    ControlPersist 30m
    PubkeyAcceptedKeyTypes +ssh-ed25519
    StrictHostKeyChecking accept-new
    # VPN-specific optimizations
    TCPKeepAlive yes
    ServerAliveCountMax 5

# VPN OFF: Use local hostname (mDNS)
Host cursor-local
    HostName abhis-macbook-air.local
    User abhimehrotra
    IdentitiesOnly yes
    RequestTTY yes
    ServerAliveInterval 60
    Compression yes
    ControlMaster auto
    ControlPath ~/.ssh/control/%r@%h:%p
    ControlPersist 30m
    PubkeyAcceptedKeyTypes +ssh-ed25519
    StrictHostKeyChecking accept-new
    # Local network optimizations
    Compression no

# FALLBACK: Use .local domain (mDNS/Bonjour)
Host cursor-mdns
    HostName abhis-macbook-air.local
    User abhimehrotra
    IdentitiesOnly yes
    RequestTTY yes
    ServerAliveInterval 60
    Compression yes
    ControlMaster auto
    ControlPath ~/.ssh/control/%r@%h:%p
    ControlPersist 30m
    PubkeyAcceptedKeyTypes +ssh-ed25519
    StrictHostKeyChecking accept-new

# SMART ALIAS: Auto-detect which connection to use
Host cursor-auto
    HostName abhis-macbook-air.local
    User abhimehrotra
    IdentitiesOnly yes
    RequestTTY yes
    ServerAliveInterval 30
    ConnectTimeout 5
    ConnectionAttempts 1
    ControlMaster auto
    ControlPath ~/.ssh/control/%r@%h:%p
    ControlPersist 30m
    PubkeyAcceptedKeyTypes +ssh-ed25519
    StrictHostKeyChecking accept-new

# ─ global defaults for all hosts ─────────────────────
Host *
  IdentityAgent "~/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"

    # Ensure compatibility with non-macOS OpenSSH
    IgnoreUnknown UseKeychain

    # Key management
    AddKeysToAgent yes
    UseKeychain yes
    IdentitiesOnly yes

    # Connection persistence and reliability
    ServerAliveInterval 60
    ServerAliveCountMax 3
    TCPKeepAlive yes

    # Connection multiplexing (ensure control directory exists)
    ControlMaster auto
    ControlPath ~/.ssh/control/%r@%h:%p
    ControlPersist 10m

    # Security settings
    StrictHostKeyChecking ask
    HashKnownHosts yes
    UserKnownHostsFile ~/.ssh/known_hosts

    # Performance and features
    Compression yes
    ForwardAgent yes
    ForwardX11 yes
    ForwardX11Trusted yes

    # Environment
    SendEnv LANG LC_*

    # Timeout settings
    ConnectTimeout 30

    # Prevent hanging connections
    ExitOnForwardFailure yes

    # Preferred key types (modern, secure)
    PubkeyAcceptedKeyTypes ssh-ed25519,ecdsa-sha2-nistp256,ssh-rsa
    HostkeyAlgorithms +ssh-ed25519,ecdsa-sha2-nistp256,ssh-rsa
    # Note: Removed trailing comma from KexAlgorithms for valid syntax
    KexAlgorithms +diffie-hellman-group-exchange-sha256,diffie-hellman-group14-sha256,curve25519-sha256
