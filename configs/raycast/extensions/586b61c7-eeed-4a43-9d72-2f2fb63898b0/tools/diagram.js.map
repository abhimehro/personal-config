{
  "version": 3,
  "sources": ["../../src/tools/diagram.ts"],
  "sourcesContent": ["import { AI } from \"@raycast/api\";\n\ntype Input = {\n  query: string;\n};\n\ntype DiagramResponse = {\n  imageURL: string;\n  fileURL: string;\n};\n\nexport default async function (input: Input) {\n  // First, determine the diagram type and request Mermaid-only output for reliable preview\n  const userQuery = typeof input?.query === \"string\" ? input.query : \"\";\n  const diagramAnalysis = await AI.ask(\n    `Analyze this request and choose the best diagram type: \"${userQuery}\"\n\nChoose EXACTLY one type from: FLOWCHART, MINDMAP, SEQUENCE.\nThen output ONLY Mermaid for that type:\n\n- FLOWCHART => start with \"flowchart TD\" or \"flowchart LR\"\n- MINDMAP   => start with \"mindmap\" then the tree\n- SEQUENCE  => start with \"sequenceDiagram\"\n\nRespond with this exact format and nothing else:\nTYPE: [FLOWCHART|MINDMAP|SEQUENCE]\n\\`\\`\\`mermaid\n<mermaid code here>\n\\`\\`\\`\n`,\n  );\n\n  // Parse the AI response to extract type and Mermaid fenced block\n  const typeRe = /TYPE:\\s*(FLOWCHART|MINDMAP|SEQUENCE)/i;\n  const fenceRe = /```mermaid\\s*([\\s\\S]*?)\\s*```/i;\n  const typeMatch = typeRe.exec(diagramAnalysis);\n  const fenceMatch = fenceRe.exec(diagramAnalysis);\n\n  if (!typeMatch || !fenceMatch) {\n    throw new Error(\"Could not parse diagram type or Mermaid content\");\n  }\n\n  const diagramType = typeMatch[1].toUpperCase();\n  const mermaidFromAI = fenceMatch[1].trim();\n  // Mermaid for preview is directly what we got from AI\n  const mermaid = mermaidFromAI;\n\n  // Converters: Mermaid -> API content for mindmap/sequence\n  const safeTitle = userQuery && userQuery.length > 0 ? userQuery.slice(0, 50) : \"Diagram\";\n\n  const mermaidToSequenceText = (mm: string) => {\n    const ls = mm.split(\"\\n\").map((l) => l.trim());\n    const out: string[] = [];\n    for (const l of ls) {\n      if (/^sequenceDiagram/i.test(l) || /^participant\\s+/i.test(l) || l === \"\") continue;\n      const m1 = /(\\S+)\\s*-+>{1,2}\\s*(\\S+)\\s*:\\s*(.+)/.exec(l);\n      if (m1) out.push(`${m1[1]} -> ${m1[2]}: ${m1[3]}`);\n    }\n    return out.join(\"\\n\");\n  };\n\n  const mermaidToMindmapMarkdown = (mm: string) => {\n    const lines = mm.split(\"\\n\");\n    const out: string[] = [];\n    let seenMindmap = false;\n    for (const rawLine of lines) {\n      const line = rawLine.replace(/\\t/g, \"  \");\n      if (!seenMindmap) {\n        if (/^\\s*mindmap\\s*$/i.test(line)) {\n          seenMindmap = true;\n        }\n        continue;\n      }\n      if (!line.trim()) continue;\n      const m = /^(\\s*)(.+)$/.exec(line);\n      if (!m) continue;\n      const indent = Math.floor((m[1] || \"\").length / 2);\n      const text = m[2].trim();\n      out.push(`${\"  \".repeat(indent)}- ${text}`);\n    }\n    if (out.length === 0) {\n      return `- ${safeTitle}`;\n    }\n    return out.join(\"\\n\");\n  };\n\n  // Call the appropriate Whimsical API based on diagram type\n  let apiEndpoint: string;\n  let requestBody: object;\n  switch (diagramType) {\n    case \"FLOWCHART\": {\n      apiEndpoint = \"https://whimsical.com/api/ai.chatgpt.render-flowchart\";\n      requestBody = { mermaid: mermaidFromAI, title: safeTitle };\n      break;\n    }\n    case \"MINDMAP\": {\n      apiEndpoint = \"https://whimsical.com/api/ai.chatgpt.render-mindmap\";\n      const markdown = mermaidToMindmapMarkdown(mermaidFromAI);\n      requestBody = { markdown, title: safeTitle };\n      break;\n    }\n    case \"SEQUENCE\": {\n      apiEndpoint = \"https://whimsical.com/api/ai.chatgpt.render-sequence-diagram\";\n      const diagramText = mermaidToSequenceText(mermaidFromAI);\n      requestBody = { diagram: diagramText, title: safeTitle };\n      break;\n    }\n    default: {\n      throw new Error(`Unknown diagram type: ${diagramType}`);\n    }\n  }\n\n  const res = await fetch(apiEndpoint, {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/json\" },\n    body: JSON.stringify(requestBody),\n  });\n\n  if (!res.ok) {\n    throw new Error(`API request failed: ${res.statusText}`);\n  }\n\n  const { fileURL } = (await res.json()) as DiagramResponse;\n\n  // Create consistent message based on diagram type\n  const diagramTypeDisplay =\n    {\n      FLOWCHART: \"Flowchart\",\n      MINDMAP: \"Mindmap\",\n      SEQUENCE: \"Sequence Diagram\",\n    }[diagramType] || \"Diagram\";\n\n  // Generate a brief summary of what was created\n  const summaryPrompt = `Briefly summarize what was created in this ${diagramType.toLowerCase()}: \"${userQuery}\"\n\nWrite a single sentence describing the main content/purpose of the diagram. Keep it concise and informative.\n\nExamples:\n- \"A flowchart showing the user authentication process with login validation steps.\"\n- \"A mindmap exploring digital marketing strategies and their key components.\"\n- \"A sequence diagram illustrating the API interaction flow for order processing.\"\n\nReturn only the summary sentence, no additional text.`;\n\n  const summary = await AI.ask(summaryPrompt);\n\n  const message = `\u2728 **${diagramTypeDisplay} Generated**\\n\\n${summary}\\n\\n\uD83D\uDD17 **Diagram URL:** ${fileURL}`;\n\n  return {\n    content: [\n      { type: \"text\", text: message },\n      // Mermaid preview in Raycast (rendered from a code fence)\n      { type: \"text\", text: [\"## Mermaid preview\", \"\", \"```mermaid\", mermaid, \"```\"].join(\"\\n\") },\n      { type: \"resource\", resource: { uri: fileURL, text: \"Open in Whimsical\" } },\n    ],\n  };\n}\n"],
  "mappings": "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",
  "names": ["diagram_exports", "__export", "diagram_default", "__toCommonJS", "import_api", "input", "userQuery", "diagramAnalysis", "typeRe", "fenceRe", "typeMatch", "fenceMatch", "diagramType", "mermaidFromAI", "mermaid", "safeTitle", "mermaidToSequenceText", "mm", "ls", "l", "out", "m1", "mermaidToMindmapMarkdown", "lines", "seenMindmap", "rawLine", "line", "m", "indent", "text", "apiEndpoint", "requestBody", "res", "fileURL", "diagramTypeDisplay", "summaryPrompt", "summary"]
}
