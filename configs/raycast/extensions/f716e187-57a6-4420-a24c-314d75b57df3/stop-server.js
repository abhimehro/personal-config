"use strict";var u=Object.defineProperty;var f=Object.getOwnPropertyDescriptor;var g=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var y=(n,t)=>{for(var a in t)u(n,a,{get:t[a],enumerable:!0})},v=(n,t,a,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let l of g(t))!S.call(n,l)&&l!==a&&u(n,l,{get:()=>t[l],enumerable:!(s=f(t,l))||s.enumerable});return n};var T=n=>v(u({},"__esModule",{value:!0}),n);var $={};y($,{default:()=>m});module.exports=T($);var o=require("@raycast/api");var p=require("path"),c=require("fs"),w="http://localhost:3049";var P="server.pid";var r=(n,t="info")=>{console.log(`[TIDAL] [${t.toUpperCase()}] ${n}`)},k=()=>{let{localApiAuthToken:n}=(0,o.getPreferenceValues)();if(!n){let t="Auth token not found in Raycast preferences.";throw r(t,"error"),new Error(t)}return{"Content-Type":"application/json",Authorization:`Bearer ${n}`}};var h=async()=>{let n=o.environment.supportPath,t=(0,p.join)(n,P);r(`Attempting to stop server. PID file path: ${t}`);let a=null,s=null,l=async()=>{try{let e=await fetch(`${w}/health`,{headers:k(),signal:AbortSignal.timeout(500)});if(e.ok){let i=await e.json();if(i&&typeof i.pid=="number")return i.pid}}catch(e){r(`Health check failed: ${e instanceof Error?e.message:String(e)}`,"warn")}return null};if((0,c.existsSync)(t))try{s=(0,c.readFileSync)(t,"utf8").trim(),s?(a=parseInt(s),r(`Found PID file with PID: ${a}`)):r("PID file is empty.")}catch(e){r(`Error reading PID file: ${e instanceof Error?e.message:String(e)}.`,"warn")}else r("PID file not found.");if(a===null)if(r("No PID from file. Checking server health endpoint for active PID."),a=await l(),a)r(`Found active server PID from health endpoint: ${a}`);else return r("Server not detected as running via health endpoint. Nothing to stop.","warn"),await(0,o.showHUD)("\u26A0\uFE0F Server not running"),!1;try{r(`Attempting to send SIGTERM to PID: ${a}`),process.kill(a,"SIGTERM"),r(`Sent SIGTERM to PID: ${a}`),await new Promise(e=>setTimeout(e,1e3))}catch(e){r(`Error sending SIGTERM to PID ${a}: ${e instanceof Error?e.message:String(e)}. Process might not exist or already stopped.`,"warn")}let d=await l();if(d===null){if(r("Server stopped successfully (final health check failed)."),await(0,o.showHUD)("\u2705 Server stopped"),(0,c.existsSync)(t))try{(0,c.unlinkSync)(t),r("PID file removed.")}catch(i){r(`Error removing PID file: ${i instanceof Error?i.message:String(i)}`,"error")}let e=(0,p.join)(n,"server.js");if((0,c.existsSync)(e))try{(0,c.unlinkSync)(e),r("server.js file removed.")}catch(i){r(`Error removing server.js file: ${i instanceof Error?i.message:String(i)}`,"error")}return!0}else{let e=`\u274C Server still running (PID: ${d}).`;return s&&d===parseInt(s)?e+=` Original PID ${s} is still active.`:s&&d!==parseInt(s)?e+=` New PID ${d} detected, original PID ${s} might have been replaced.`:e+=" No original PID file found.",r(e,"error"),await(0,o.showHUD)(e),!1}};async function m(){await h()}
