"use strict";"use client";var y=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var Q=Object.prototype.hasOwnProperty;var W=(e,r)=>{for(var s in r)y(e,s,{get:r[s],enumerable:!0})},Y=(e,r,s,c)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of X(r))!Q.call(e,o)&&o!==s&&y(e,o,{get:()=>r[o],enumerable:!(c=V(r,o))||c.enumerable});return e};var Z=e=>Y(y({},"__esModule",{value:!0}),e);var te={};W(te,{default:()=>F});module.exports=Z(te);var t=require("@raycast/api"),i=require("react");var a=require("@raycast/api");var h="http://localhost:3049",f=1e3;var d=(e,r="info")=>{console.log(`[TIDAL] [${r.toUpperCase()}] ${e}`)},v=()=>{let{localApiAuthToken:e}=(0,a.getPreferenceValues)();if(!e){let r="Auth token not found in Raycast preferences.";throw d(r,"error"),new Error(r)}return{"Content-Type":"application/json",Authorization:`Bearer ${e}`}};var ee=async(e,r)=>{if(r&&r!=="connected")return(0,a.showToast)({style:a.Toast.Style.Failure,title:"Not Connected",message:"Server connection lost"}),!1;try{let s=await fetch(`${h}/send-command`,{method:"POST",headers:v(),body:JSON.stringify({action:e}),signal:AbortSignal.timeout(f)});if(s.ok)return d(`Command sent: ${e}`),!0;{let c=await s.text();throw new Error(`Command failed: ${s.status} - ${c}`)}}catch(s){return d(`Command error: ${s}`,"error"),(0,a.showToast)({style:a.Toast.Style.Failure,title:"Command Failed",message:String(s)}),!1}},C=async()=>{try{let e=await fetch(`${h}/status`,{headers:v(),signal:AbortSignal.timeout(f)});return e.ok?await e.json():null}catch(e){return d(`Failed to get server status: ${e}`,"error"),null}};var I=async()=>{try{let e=v(),r=await fetch(`${h}/health`,{headers:e,signal:AbortSignal.timeout(f)});if(!r.ok)throw new Error(`Health check failed: ${r.status}`);let s=await fetch(`${h}/current-track`,{headers:e,signal:AbortSignal.timeout(f)});if(s.ok){let c=await s.json();if("status"in c&&c.status==="no-data")return{track:{title:"No Track Playing",artist:"Open Tidal and play a song",isPlaying:!1,playingFrom:"",currentTime:"0:00",duration:"0:00",isLiked:!1,isShuffled:!1,repeatMode:"off"},hasRealData:!1,serverStatus:"connected"};if("title"in c&&c.title&&c.title!=="Unknown"){let o=Date.now()-(c.timestamp||0);return o<6e5?{track:c,hasRealData:!0,serverStatus:"connected"}:{track:{title:"Stale Data",artist:`Chrome inactive? (${Math.round(o/1e3)}s)`,isPlaying:!1,playingFrom:"",currentTime:"0:00",duration:"0:00",isLiked:!1,isShuffled:!1,repeatMode:"off"},hasRealData:!1,serverStatus:"connected"}}}return{track:{title:"Loading...",artist:"Connecting...",isPlaying:!1,playingFrom:"",currentTime:"0:00",duration:"0:00",isLiked:!1,isShuffled:!1,repeatMode:"off"},hasRealData:!1,serverStatus:"connected"}}catch(e){return d(`Refresh error: ${e} (is the server down??)`,"error"),{track:{title:"Connection Error",artist:"Server not responding or auth failed",isPlaying:!1,playingFrom:"",currentTime:"0:00",duration:"0:00",isLiked:!1,isShuffled:!1,repeatMode:"off"},hasRealData:!1,serverStatus:"disconnected"}}},p=(e,r,s)=>async()=>{await ee(e,r)&&setTimeout(s,200)},$=async()=>{try{await(0,a.launchCommand)({name:"server-status",type:a.LaunchType.UserInitiated})}catch(e){d(`Failed to open server status: ${e}`,"error"),await(0,a.showToast)({style:a.Toast.Style.Failure,title:"Failed to Open Status"})}},D=async()=>{try{await(0,a.openExtensionPreferences)()}catch(e){d(`Failed to open preferences: ${e}`,"error"),await(0,a.showToast)({style:a.Toast.Style.Failure,title:"Failed to Open Preferences"})}},b=async()=>{try{await(0,a.open)("https://github.com/Ek2100/tidal/blob/main/raycast/README.md")}catch(e){d(`Failed to open documentation: ${e}`,"error"),await(0,a.showToast)({style:a.Toast.Style.Failure,title:"Failed to Open Documentation"})}},A=async e=>{try{await(0,a.launchCommand)({name:"start-server",type:a.LaunchType.Background}),setTimeout(e,2e3)}catch(r){await(0,a.showHUD)("\u274C Failed to start server"),d(`Failed to start server: ${r}`,"error")}},E=async()=>{try{await(0,a.launchCommand)({name:"stop-server",type:a.LaunchType.Background})}catch(e){await(0,a.showHUD)("\u274C Failed to stop server"),d(`Failed to stop server: ${e}`,"error")}};var R=e=>{let r=Math.floor(e/1e3),s=Math.floor(r/60),c=Math.floor(s/60);return c>0?`${c}h ${s%60}m`:s>0?`${s}m ${r%60}s`:`${r}s`},x=e=>{switch(e){case"one":return"ArrowClockwise";case"all":return"Repeat";default:return"MinusCircle"}},O=e=>{switch(e){case"one":return"Repeat: One";case"all":return"Repeat: All";default:return"Repeat: Off"}};var H=(e,r,s)=>{if(e&&r.title!=="Loading..."&&r.title!=="No Track Playing")return`${r.title.substring(0,25)}${r.title.length>25?"...":""}`;switch(s){case"connected":return"Tidal";case"connecting":return"Loading...";default:return"Offline"}};var n=require("react/jsx-runtime");function F(){let[e,r]=(0,i.useState)({title:"Loading...",artist:"Connecting...",isPlaying:!1,playingFrom:"",currentTime:"0:00",duration:"0:00",isLiked:!1,isShuffled:!1,repeatMode:"off"}),[s,c]=(0,i.useState)(!1),[o,g]=(0,i.useState)("connecting"),[T,w]=(0,i.useState)(null),[k,P]=(0,i.useState)(0),S=(0,i.useRef)(null),l=(0,i.useCallback)(async()=>{let u=await I();if(r(u.track),c(u.hasRealData),g(u.serverStatus),u.serverStatus==="connected"){w(new Date);let m=await C();m&&P(m.uptime)}else w(null),P(0)},[]);(0,i.useEffect)(()=>(l(),S.current=setInterval(l,5e3),()=>{S.current&&clearInterval(S.current)}),[l]);let M=(0,i.useCallback)(async()=>{let u=!e.isPlaying;r(K=>({...K,isPlaying:u})),await p(u?"play":"pause",o,l)()},[e.isPlaying,o,l]),N=(0,i.useCallback)(()=>p("next",o,l)(),[o,l]),L=(0,i.useCallback)(()=>p("previous",o,l)(),[o,l]),U=(0,i.useCallback)(async()=>{r(m=>({...m,isLiked:!m.isLiked})),await p("toggleLike",o,l)()},[o,l]),j=(0,i.useCallback)(async()=>{r(m=>({...m,isShuffled:!m.isShuffled})),await p("toggleShuffle",o,l)()},[o,l]),_=(0,i.useCallback)(()=>p("toggleRepeat",o,l)(),[o,l]),q=(0,i.useCallback)(()=>{g("connecting"),A(l)},[l]),G=(0,i.useCallback)(async()=>{g("connecting"),await E()},[l]),B=H(s,e,o),J=x(e.repeatMode),z=O(e.repeatMode);return(0,n.jsxs)(t.MenuBarExtra,{icon:e?.isPlaying?t.Icon.Pause:t.Icon.Play,title:B,isLoading:o==="connecting",tooltip:s&&e?`${e.title} - ${e.artist}`:"Tidal Controller",children:[s&&e?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(t.MenuBarExtra.Section,{title:"Current Track",children:[(0,n.jsx)(t.MenuBarExtra.Item,{title:e.title,icon:e.isLiked?t.Icon.Heart:t.Icon.Music}),(0,n.jsx)(t.MenuBarExtra.Item,{title:e.artist,icon:t.Icon.Person}),(0,n.jsx)(t.MenuBarExtra.Item,{title:`${e.currentTime} / ${e.duration}`,icon:t.Icon.Clock}),e.playingFrom&&(0,n.jsx)(t.MenuBarExtra.Item,{title:e.playingFrom,icon:t.Icon.List})]}),(0,n.jsxs)(t.MenuBarExtra.Section,{title:"Playback Controls",children:[(0,n.jsx)(t.MenuBarExtra.Item,{title:"Previous",icon:t.Icon.Rewind,onAction:L,shortcut:{modifiers:["cmd"],key:"q"}}),(0,n.jsx)(t.MenuBarExtra.Item,{title:e.isPlaying?"Pause":"Play",icon:e.isPlaying?t.Icon.Pause:t.Icon.Play,onAction:M,shortcut:{modifiers:["cmd"],key:"w"}}),(0,n.jsx)(t.MenuBarExtra.Item,{title:"Next",icon:t.Icon.Forward,onAction:N,shortcut:{modifiers:["cmd"],key:"e"}})]}),(0,n.jsxs)(t.MenuBarExtra.Section,{title:"Track Actions",children:[(0,n.jsx)(t.MenuBarExtra.Item,{title:e.isLiked?"Unlike":"Like",icon:e.isLiked?t.Icon.HeartDisabled:t.Icon.Heart,onAction:U,shortcut:{modifiers:["cmd"],key:"r"}}),(0,n.jsx)(t.MenuBarExtra.Item,{title:`Shuffle: ${e.isShuffled?"On":"Off"}`,icon:e.isShuffled?t.Icon.Shuffle:t.Icon.List,onAction:j,shortcut:{modifiers:["cmd"],key:"t"}}),(0,n.jsx)(t.MenuBarExtra.Item,{title:z,icon:t.Icon[J],onAction:_,shortcut:{modifiers:["cmd"],key:"y"}})]})]}):(0,n.jsxs)(t.MenuBarExtra.Section,{title:"Status",children:[o==="disconnected"?(0,n.jsx)(t.MenuBarExtra.Item,{title:"Server Offline",icon:t.Icon.XMarkCircle}):(0,n.jsx)(t.MenuBarExtra.Item,{title:"No Track Playing",icon:t.Icon.Music}),(0,n.jsx)(t.MenuBarExtra.Item,{title:"Open Documentation",icon:t.Icon.Book,onAction:b})]}),(0,n.jsx)(t.MenuBarExtra.Section,{children:(0,n.jsxs)(t.MenuBarExtra.Submenu,{title:"Server",icon:t.Icon.ComputerChip,children:[o==="connected"?(0,n.jsx)(t.MenuBarExtra.Item,{title:"Connected (Click to Stop)",icon:t.Icon.CheckCircle,onAction:G}):(0,n.jsx)(t.MenuBarExtra.Item,{title:o==="connecting"?"Connecting...":"Disconnected (Click to Start)",icon:o==="connecting"?t.Icon.Clock:t.Icon.XMarkCircle,onAction:q}),(0,n.jsx)(t.MenuBarExtra.Item,{title:"View Server Status Details",icon:t.Icon.BarChart,onAction:$}),(0,n.jsx)(t.MenuBarExtra.Item,{title:"Launch Extension Preferences",icon:t.Icon.Gear,onAction:D}),o==="connected"&&T&&(0,n.jsx)(t.MenuBarExtra.Item,{title:`Last Updated: ${T.toLocaleTimeString()}`,icon:t.Icon.Clock}),o==="connected"&&k>0&&(0,n.jsx)(t.MenuBarExtra.Item,{title:`Uptime: ${R(k)}`,icon:t.Icon.Hourglass})]})})]})}
