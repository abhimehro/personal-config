name: Code Quality & Complexity Checks

on:
  pull_request:
    paths:
      - '**.sh'
      - '**.py'
      - '**.bash'
      - 'scripts/**'
      - 'tests/**'
      - 'controld-system/**'
      - 'windscribe-controld/**'
      - '.github/workflows/**'
  push:
    branches:
      - main
      - master
  workflow_dispatch:

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Limit permissions for security
permissions:
  contents: read

jobs:
  shellcheck-complexity:
    name: Shell Script Complexity Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Find shell scripts
        id: find-scripts
        run: |
          # Find all shell scripts (excluding archive and hidden directories)
          find . -type f \( -name "*.sh" -o -name "*.bash" \) \
            ! -path "./.git/*" \
            ! -path "./node_modules/*" \
            ! -path "./.local/*" \
            ! -path "./archive/*" \
            ! -path "./.Jules/*" \
            ! -path "./.jules/*" \
            ! -path "./.cursor/*" \
            > /tmp/shell_files.txt
          
          echo "Found $(wc -l < /tmp/shell_files.txt) shell scripts"
          cat /tmp/shell_files.txt

      - name: Run ShellCheck
        run: |
          echo "Running ShellCheck on all shell scripts..."
          
          # ShellCheck all files (non-fatal: emit GitHub warnings but do not fail the job)
          while IFS= read -r file; do
            echo "Checking: $file"
            # The '|| echo' fallback is intentional so ShellCheck findings are reported as warnings only.
            shellcheck -S warning "$file" || echo "::warning file=$file::ShellCheck found issues"
          done < /tmp/shell_files.txt
          
          echo "ShellCheck completed"

      - name: Check script complexity
        run: |
          echo "Checking for overly complex shell scripts..."
          echo "Scripts with >200 lines should be reviewed for refactoring opportunities:"
          echo ""
          
          while IFS= read -r file; do
            lines=$(wc -l < "$file")
            if [ "$lines" -gt 200 ]; then
              echo "::warning file=$file::Script has $lines lines (>200 line threshold). Consider refactoring into smaller functions or modules."
            fi
          done < /tmp/shell_files.txt
          
          echo ""
          echo "Complexity check completed"

  python-complexity:
    name: Python Code Complexity Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install complexity analysis tools
        run: |
          pip install radon

      - name: Find Python files
        id: find-python
        run: |
          # Find all Python files (excluding archive and hidden directories)
          find . -type f -name "*.py" \
            ! -path "./.git/*" \
            ! -path "./node_modules/*" \
            ! -path "./.local/*" \
            ! -path "./archive/*" \
            ! -path "./.venv/*" \
            ! -path "./venv/*" \
            > /tmp/python_files.txt
          
          echo "Found $(wc -l < /tmp/python_files.txt) Python files"
          cat /tmp/python_files.txt

      - name: Check cyclomatic complexity
        run: |
          echo "Checking cyclomatic complexity..."
          echo ""
          
          if [ ! -s /tmp/python_files.txt ]; then
            echo "No Python files found to check"
            exit 0
          fi
          
          # Create Python helper script
          cat > /tmp/check_complexity.py << 'PYEOF'
          import sys
          import json
          
          try:
              data = json.load(sys.stdin)
              for file_path, items in data.items():
                  for item in items:
                      if item.get('complexity', 0) > 10:
                          print(f"{item['type']} '{item['name']}' has complexity {item['complexity']} (line {item['lineno']})")
          except json.JSONDecodeError as e:
              # Log JSON parsing errors for easier troubleshooting
              sys.stderr.write(f"Failed to parse radon JSON output: {e}\n")
          except (TypeError, ValueError) as e:
              # Log data structure issues without failing the workflow
              sys.stderr.write(f"Invalid data structure in radon output: {e}\n")
          PYEOF
          
          # Ensure radon is available before running checks
          if ! command -v radon >/dev/null 2>&1; then
            echo "::error::radon is not installed or not found in PATH; skipping cyclomatic complexity checks"
            exit 1
          fi
          
          # Check cyclomatic complexity (CC)
          # Thresholds: A=1-5 (simple), B=6-10 (moderate), C=11-20 (complex), D=21-50 (very complex), F=>50 (extremely complex)
          while IFS= read -r file; do
            echo "Analyzing: $file"
            
            # Get complexity report
            if ! radon cc "$file" -s -n C; then
              echo "::error file=$file::radon cc summary analysis failed for $file"
              continue
            fi
            
            # Check for functions/methods with complexity > 10 (above moderate)
            if ! high_complexity=$(radon cc "$file" --json | python3 /tmp/check_complexity.py); then
              echo "::error file=$file::radon cc JSON analysis failed for $file"
              continue
            fi
            
            if [ -n "$high_complexity" ]; then
              echo "::warning file=$file::$high_complexity - Consider refactoring to reduce complexity"
            fi
          done < /tmp/python_files.txt
          
          echo ""
          echo "Cyclomatic complexity check completed"

      - name: Check maintainability index
        run: |
          echo "Checking maintainability index..."
          echo ""
          
          if [ ! -s /tmp/python_files.txt ]; then
            echo "No Python files found to check"
            exit 0
          fi
          
          # Create Python helper script
          cat > /tmp/check_mi.py << 'PYEOF'
          import sys
import sys
import json

try:
    data = json.load(sys.stdin)
    for file_path, mi_data in data.items():
        if mi_data['mi'] < 20:
            print(f"{mi_data['mi']:.1f}")
except Exception:
    # Silently handle JSON parsing or data structure errors
    pass
PYEOF
          
          # Check maintainability index (MI)
          # MI >= 20: Maintainable, 10-19: Moderate, <10: Difficult to maintain
          while IFS= read -r file; do
            mi=$(radon mi "$file" -s -j | python3 /tmp/check_mi.py || echo "")
            
            if [ -n "$mi" ]; then
              echo "::warning file=$file::Maintainability index is $mi (<20). Consider refactoring to improve maintainability."
            fi
          done < /tmp/python_files.txt
          
          echo ""
          echo "Maintainability index check completed"

      - name: Check file length
        run: |
          echo "Checking for overly long Python files..."
          echo ""
          
          if [ ! -s /tmp/python_files.txt ]; then
            echo "No Python files found to check"
            exit 0
          fi
          
          while IFS= read -r file; do
            lines=$(wc -l < "$file")
            if [ "$lines" -gt 300 ]; then
              echo "::warning file=$file::File has $lines lines (>300 line threshold). Consider splitting into smaller modules."
            fi
          done < /tmp/python_files.txt
          
          echo ""
          echo "File length check completed"

  trunk-check:
    name: Trunk Check (Existing Linters)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Trunk
        run: |
          curl -fsSL https://get.trunk.io | bash -s -- -y

      - name: Run Trunk Check
        run: |
          # Run trunk check on changed files
          # Try with main first, fall back to master if it doesn't exist
          if git rev-parse --verify origin/main >/dev/null 2>&1; then
            ~/.trunk/bin/trunk check --all --upstream origin/main || true
          elif git rev-parse --verify origin/master >/dev/null 2>&1; then
            ~/.trunk/bin/trunk check --all --upstream origin/master || true
          else
            ~/.trunk/bin/trunk check --all || true
          fi
          
          echo ""
          echo "Trunk check completed"

  summary:
    name: Code Quality Summary
    runs-on: ubuntu-latest
    needs: [shellcheck-complexity, python-complexity, trunk-check]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Code Quality Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Shell script complexity check: ${{ needs.shellcheck-complexity.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Python complexity check: ${{ needs.python-complexity.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Trunk linter check: ${{ needs.trunk-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Complexity Thresholds" >> $GITHUB_STEP_SUMMARY
          echo "- **Shell scripts**: >200 lines triggers warning" >> $GITHUB_STEP_SUMMARY
          echo "- **Python cyclomatic complexity**: >10 triggers warning" >> $GITHUB_STEP_SUMMARY
          echo "- **Python maintainability index**: <20 triggers warning" >> $GITHUB_STEP_SUMMARY
          echo "- **Python file length**: >300 lines triggers warning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "These are **warnings** to encourage better code organization, not blocking errors." >> $GITHUB_STEP_SUMMARY
